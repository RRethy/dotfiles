"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
const vscode_languageserver_protocol_1 = require("vscode-languageserver-protocol");
const coc_nvim_1 = require("coc.nvim");
const baseCodeLensProvider_1 = require("./features/baseCodeLensProvider");
const bufferSyncSupport_1 = tslib_1.__importDefault(require("./features/bufferSyncSupport"));
const completionItemProvider_1 = tslib_1.__importDefault(require("./features/completionItemProvider"));
const definitionProvider_1 = tslib_1.__importDefault(require("./features/definitionProvider"));
const diagnostics_1 = require("./features/diagnostics");
const directiveCommentCompletions_1 = tslib_1.__importDefault(require("./features/directiveCommentCompletions"));
const documentHighlight_1 = tslib_1.__importDefault(require("./features/documentHighlight"));
const documentSymbol_1 = tslib_1.__importDefault(require("./features/documentSymbol"));
const fileConfigurationManager_1 = tslib_1.__importDefault(require("./features/fileConfigurationManager"));
const folding_1 = tslib_1.__importDefault(require("./features/folding"));
const formatting_1 = tslib_1.__importDefault(require("./features/formatting"));
const hover_1 = tslib_1.__importDefault(require("./features/hover"));
const implementationsCodeLens_1 = tslib_1.__importDefault(require("./features/implementationsCodeLens"));
// import TagCompletionProvider from './features/tagCompletion'
const quickfix_1 = tslib_1.__importDefault(require("./features/quickfix"));
const refactor_1 = tslib_1.__importDefault(require("./features/refactor"));
const references_1 = tslib_1.__importDefault(require("./features/references"));
const referencesCodeLens_1 = tslib_1.__importDefault(require("./features/referencesCodeLens"));
const rename_1 = tslib_1.__importDefault(require("./features/rename"));
const signatureHelp_1 = tslib_1.__importDefault(require("./features/signatureHelp"));
const updatePathOnRename_1 = tslib_1.__importDefault(require("./features/updatePathOnRename"));
const watchBuild_1 = tslib_1.__importDefault(require("./features/watchBuild"));
const workspaceSymbols_1 = tslib_1.__importDefault(require("./features/workspaceSymbols"));
const api_1 = tslib_1.__importDefault(require("./utils/api"));
const validateSetting = 'validate.enable';
const suggestionSetting = 'suggestionActions.enabled';
class LanguageProvider {
    constructor(client, description, typingsStatus) {
        this.client = client;
        this.description = description;
        this._validate = true;
        this._enableSuggestionDiagnostics = true;
        this.disposables = [];
        this.fileConfigurationManager = new fileConfigurationManager_1.default(client);
        this.bufferSyncSupport = new bufferSyncSupport_1.default(client, description.modeIds, this._validate);
        this.diagnosticsManager = new diagnostics_1.DiagnosticsManager();
        this.disposables.push(this.diagnosticsManager);
        client.onTsServerStarted(() => tslib_1.__awaiter(this, void 0, void 0, function* () {
            let document = yield coc_nvim_1.workspace.document;
            if (description.modeIds.indexOf(document.filetype) !== -1) {
                this.fileConfigurationManager.ensureConfigurationForDocument(document.textDocument); // tslint:disable-line
            }
        }));
        coc_nvim_1.events.on('BufEnter', bufnr => {
            let doc = coc_nvim_1.workspace.getDocument(bufnr);
            if (!doc)
                return;
            if (description.modeIds.indexOf(doc.filetype) == -1)
                return;
            if (client.state !== coc_nvim_1.ServiceStat.Running)
                return;
            this.fileConfigurationManager.ensureConfigurationForDocument(doc.textDocument); // tslint:disable-line
        }, this, this.disposables);
        this.configurationChanged();
        coc_nvim_1.workspace.onDidChangeConfiguration(this.configurationChanged, this, this.disposables);
        let initialized = false;
        client.onTsServerStarted(() => {
            if (!initialized) {
                initialized = true;
                this.registerProviders(client, typingsStatus);
                this.bufferSyncSupport.listen();
            }
            else {
                this.reInitialize();
            }
        });
    }
    dispose() {
        coc_nvim_1.disposeAll(this.disposables);
        this.bufferSyncSupport.dispose();
    }
    configurationChanged() {
        const config = coc_nvim_1.workspace.getConfiguration(this.id);
        this.updateValidate(config.get(validateSetting, true));
        this.updateSuggestionDiagnostics(config.get(suggestionSetting, true));
    }
    registerProviders(client, typingsStatus) {
        let languageIds = this.description.modeIds;
        this.disposables.push(coc_nvim_1.languages.registerCompletionItemProvider(`tsserver-${this.description.id}`, 'TSC', languageIds, new completionItemProvider_1.default(client, typingsStatus, this.fileConfigurationManager, this.description.id), completionItemProvider_1.default.triggerCharacters));
        if (this.client.apiVersion.gte(api_1.default.v230)) {
            this.disposables.push(coc_nvim_1.languages.registerCompletionItemProvider(`${this.description.id}-directive`, 'TSC', languageIds, new directiveCommentCompletions_1.default(client), ['@']));
        }
        let definitionProvider = new definitionProvider_1.default(client);
        this.disposables.push(coc_nvim_1.languages.registerDefinitionProvider(languageIds, definitionProvider));
        this.disposables.push(coc_nvim_1.languages.registerTypeDefinitionProvider(languageIds, definitionProvider));
        this.disposables.push(coc_nvim_1.languages.registerImplementationProvider(languageIds, definitionProvider));
        this.disposables.push(coc_nvim_1.languages.registerReferencesProvider(languageIds, new references_1.default(client)));
        this.disposables.push(coc_nvim_1.languages.registerHoverProvider(languageIds, new hover_1.default(client)));
        this.disposables.push(coc_nvim_1.languages.registerDocumentHighlightProvider(languageIds, new documentHighlight_1.default(this.client)));
        this.disposables.push(coc_nvim_1.languages.registerSignatureHelpProvider(languageIds, new signatureHelp_1.default(client), ['(', ',', '<', ')']));
        this.disposables.push(coc_nvim_1.languages.registerDocumentSymbolProvider(languageIds, new documentSymbol_1.default(client)));
        this.disposables.push(coc_nvim_1.languages.registerWorkspaceSymbolProvider(languageIds, new workspaceSymbols_1.default(client, languageIds)));
        this.disposables.push(coc_nvim_1.languages.registerRenameProvider(languageIds, new rename_1.default(client)));
        let formatProvider = new formatting_1.default(client, this.fileConfigurationManager);
        this.disposables.push(coc_nvim_1.languages.registerDocumentFormatProvider(languageIds, formatProvider));
        this.disposables.push(coc_nvim_1.languages.registerDocumentRangeFormatProvider(languageIds, formatProvider));
        this.disposables.push(coc_nvim_1.languages.registerOnTypeFormattingEditProvider(languageIds, formatProvider, [';', '}', '\n', String.fromCharCode(27)]));
        // this.disposables.push(
        //   new ProjectError(client, commandManager)
        // )
        if (this.client.apiVersion.gte(api_1.default.v280)) {
            this.disposables.push(coc_nvim_1.languages.registerFoldingRangeProvider(languageIds, new folding_1.default(this.client)));
        }
        let { fileConfigurationManager } = this;
        let conf = fileConfigurationManager.getLanguageConfiguration(this.id);
        if (this.client.apiVersion.gte(api_1.default.v290)
            && conf.get('updateImportsOnFileMove.enable')) {
            this.disposables.push(new updatePathOnRename_1.default(client, this.fileConfigurationManager, this.id));
        }
        if (this.client.apiVersion.gte(api_1.default.v240)) {
            this.disposables.push(coc_nvim_1.languages.registerCodeActionProvider(languageIds, new refactor_1.default(client, this.fileConfigurationManager), 'tsserver', [vscode_languageserver_protocol_1.CodeActionKind.Refactor]));
        }
        this.disposables.push(coc_nvim_1.languages.registerCodeActionProvider(languageIds, new quickfix_1.default(client, this.diagnosticsManager, this.bufferSyncSupport), 'tsserver', [vscode_languageserver_protocol_1.CodeActionKind.QuickFix]));
        let cachedResponse = new baseCodeLensProvider_1.CachedNavTreeResponse();
        if (this.client.apiVersion.gte(api_1.default.v206)
            && conf.get('referencesCodeLens.enable')) {
            this.disposables.push(coc_nvim_1.languages.registerCodeLensProvider(languageIds, new referencesCodeLens_1.default(client, cachedResponse)));
        }
        if (this.client.apiVersion.gte(api_1.default.v220)
            && conf.get('implementationsCodeLens.enable')) {
            this.disposables.push(coc_nvim_1.languages.registerCodeLensProvider(languageIds, new implementationsCodeLens_1.default(client, cachedResponse)));
        }
        if (this.description.id == 'typescript') {
            this.disposables.push(new watchBuild_1.default(coc_nvim_1.commands));
        }
        // if (this.client.apiVersion.gte(API.v300)) {
        //   this.disposables.push(
        //     languages.registerCompletionItemProvider(
        //       `tsserver-${this.description.id}-tag`,
        //       'TSC',
        //       languageIds,
        //       new TagCompletionProvider(client),
        //       ['>']
        //     )
        //   )
        // }
    }
    handles(resource) {
        let { modeIds, configFile } = this.description;
        if (resource.toString().endsWith(configFile)) {
            return true;
        }
        let doc = coc_nvim_1.workspace.getDocument(resource.toString());
        if (doc && modeIds.indexOf(doc.filetype) !== -1) {
            return true;
        }
        let str = resource.toString();
        if (this.id === 'typescript' && /\.ts(x)?$/.test(str)) {
            return true;
        }
        if (this.id === 'javascript' && /\.js(x)?$/.test(str)) {
            return true;
        }
        return false;
    }
    get id() {
        return this.description.id;
    }
    get diagnosticSource() {
        return this.description.diagnosticSource;
    }
    updateValidate(value) {
        if (this._validate === value) {
            return;
        }
        this._validate = value;
        this.bufferSyncSupport.validate = value;
        this.diagnosticsManager.validate = value;
        if (value) {
            this.triggerAllDiagnostics();
        }
    }
    updateSuggestionDiagnostics(value) {
        if (this._enableSuggestionDiagnostics === value) {
            return;
        }
        this._enableSuggestionDiagnostics = value;
        this.diagnosticsManager.enableSuggestions = value;
        if (value) {
            this.triggerAllDiagnostics();
        }
    }
    reInitialize() {
        this.diagnosticsManager.reInitialize();
        this.bufferSyncSupport.reInitialize();
    }
    triggerAllDiagnostics() {
        this.bufferSyncSupport.requestAllDiagnostics();
    }
    diagnosticsReceived(diagnosticsKind, file, diagnostics) {
        this.diagnosticsManager.diagnosticsReceived(diagnosticsKind, file.toString(), diagnostics);
    }
    configFileDiagnosticsReceived(uri, diagnostics) {
        this.diagnosticsManager.configFileDiagnosticsReceived(uri.toString(), diagnostics);
    }
}
exports.default = LanguageProvider;
//# sourceMappingURL=languageProvider.js.map